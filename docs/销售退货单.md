# 销售退货下载功能用户操作手册

## 一、功能概述
本功能主要用于将销售退货单的相关信息导出为Excel文件，方便用户进行查看和记录。

## 二、操作步骤

### （一）准备工作
确保已经安装了相关的Odoo环境，并且本模块（`sale_return`）已经正确加载。

### （二）打开销售退货下载界面
在Odoo系统中找到销售退货下载相关的功能入口（具体位置可能因系统配置而异），进入`SaleReturnDownload`模型对应的界面。

### （三）选择销售退货单
在界面中找到“销售退货单”字段（对应的模型字段为`order_ids`），该字段为多选字段。
- 点击该字段，会弹出选择框，用户可以从中选择一个或多个需要导出的销售退货单。
- 选择完成后，点击确认按钮。

### （四）选择类型
“类型”字段（对应的模型字段为`type`）默认为“销售退货单”（值为`return`），一般情况下无需修改。

### （五）点击下载按钮
在界面中找到“下载”按钮（对应的方法为`action_download`），点击该按钮。

### （六）导出Excel文件
点击下载按钮后，系统会调用`action_download`方法，该方法会将相关数据传递给后端控制器。后端控制器接收到请求后，会生成一个Excel文件，并将其返回给用户。
- 浏览器会弹出下载提示框，用户可以选择保存文件的位置。
- 保存的文件名为“销售退货”加上当前日期时间的组合，格式为`.xls`。

## 三、代码实现说明

### （一）前端模型部分
相关代码位于`sale_return/wizard/sale_return_download.py`文件中。
```python
class SaleReturnDownload(models.Model):
    _name="sale.return.download"
    _description="销售退货下载"
    
    order_ids = fields.Many2many('sale.return',string='销售退货单',required=True)
    type = fields.Selection([('return','销售退货单')],string='类型',required=True,default="return")
    
    def action_download(self):
        datas = {
             'data': json.dumps({'order_ids':self.order_ids.ids,'type':self.type}),
             'token':fields.Datetime.now(),
            }
        webapi_url = '/web/export/sale_return_xls'
        return {
            'type' : 'ir.actions.act_url',
            'url'  : '{url}?{data}'.format(url=webapi_url, data=werkzeug.url_encode(datas)),
            'target': 'new',
            }
```
- `order_ids`：用于存储用户选择的销售退货单的ID。
- `type`：用于指定导出的类型，默认为“销售退货单”。
- `action_download`方法：将用户选择的销售退货单的ID和类型打包成JSON数据，传递给后端控制器。

### （二）后端控制器部分
相关代码位于`sale_return/controllers/download.py`文件中。
```python
class SaleReturnXlsRrport(http.Controller):
    
    @http.route('/web/export/sale_return_xls', type='http', auth="user")
    def index(self, req, data, token, debug=False):
        data = json.loads(data)
        if data['type'] == 'return':
            return_objs = request.env['sale.return'].browse(data['order_ids'])
            output = io.BytesIO()
            workbook=xlsxwriter.Workbook(output, {'in_memory': True})
            # 定义各种格式
            title_sty= workbook.add_format({'font_size': 14,'valign': 'vcenter','align':'center','font':'Arial','bold':True})
            font_sty = workbook.add_format({'font_size': 10,'valign': 'vcenter','align':'left','font':'Arial'})
            table_sty = workbook.add_format({'font_size': 10,'valign': 'vcenter','align':'center','font':'Arial','border':1,'bold':True})
            right_sty = workbook.add_format({'text_wrap':True,'border': 1, 'font_size': 10, 'align': 'right','font':'Arial','valign' : 'vcenter'})
            left_sty = workbook.add_format({'text_wrap':True,'border': 1, 'font_size': 10, 'align': 'left','font':'Arial','valign' : 'vcenter'})
            
            for sale_return in return_objs:
                worksheet = workbook.add_worksheet(sale_return.name or "销售退货单")
                # 设置工作表属性
                worksheet.set_portrait()
                worksheet.center_horizontally()
                worksheet.fit_to_pages(1, 1)
                
                # 写入表头信息
                worksheet.merge_range(0,0, 1, 7, '销售退货单',title_sty)
                worksheet.write(2,0, "退货单号："+(sale_return.name or ''),font_sty)
                # ......（省略部分写入代码）
                
                # 写入产品明细信息
                row_count=8
                for line in sale_return.lines:
                    tax_name=','.join([tax.name for tax in line.tax_id])
                    worksheet.write(row_count, 0, line.product_id.name or '',left_sty)
                    # ......（省略部分写入代码）
                    row_count+=1
                # 写入汇总信息
                worksheet.write(row_count, 2, "未税金额：",font_sty) 
                # ......（省略部分写入代码）
                worksheet.set_column('A:H', 12)
            workbook.close()
            output.seek(0)
            generated_file = output.read()
            output.close()
            filename = '销售退货'+datetime.datetime.now().strftime('%Y%m%d%H%M%S%f')+'.xls'
            httpheaders = [
                ('Content-Type', 'application/vnd.ms-excel'),
                ('Content-Disposition', content_disposition(filename)),
            ]
            response=request.make_response(None, headers=httpheaders)
            response.stream.write(generated_file)
            response.set_cookie('fileToken', token)
            return response
```
- `index`方法：接收前端传递过来的数据，根据销售退货单的ID查询相关记录，然后将记录中的信息写入Excel文件，并返回给用户。

## 四、注意事项
- 确保用户具有相应的权限，否则可能无法正常使用该功能。
- 在选择销售退货单时，尽量选择合理数量的记录，避免导出数据过大导致性能问题。
- 导出的文件格式为`.xls`，如果需要使用其他格式，需要对代码进行相应的修改。